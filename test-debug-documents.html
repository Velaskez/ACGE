<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Documents - ACGE</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .problem {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .belongs-yes { color: green; font-weight: bold; }
        .belongs-no { color: #999; }
        .current-user { background: #e7f3ff; }
    </style>
</head>
<body>
    <h1>üîç Debug Documents - ACGE</h1>
    
    <div class="card">
        <button onclick="checkDocuments()">Analyser les Documents</button>
        <button onclick="fixOwnership()" style="background: #28a745; margin-left: 10px;">R√©assigner TOUS les Documents</button>
        <button onclick="location.reload()" style="background: #6c757d; margin-left: 10px;">Rafra√Æchir</button>
    </div>

    <div id="results"></div>

    <script>
        async function checkDocuments() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="card">‚è≥ Chargement en cours...</div>';
            
            try {
                const response = await fetch('/api/debug-documents', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayResults(data.debug);
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="card">
                        <h2>‚ùå Erreur</h2>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        async function fixOwnership() {
            if (!confirm('Voulez-vous vraiment r√©assigner TOUS les documents et dossiers √† votre compte utilisateur actuel ?')) {
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="card">‚è≥ R√©assignation en cours...</div>';
            
            try {
                const response = await fetch('/api/fix-documents-ownership', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ reassignAll: true })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="card">
                        <h2>‚úÖ R√©assignation Termin√©e</h2>
                        <div class="status success" style="display: block; margin: 15px 0; padding: 15px;">
                            ${data.message}
                        </div>
                        <h3>Statistiques mises √† jour :</h3>
                        <ul>
                            <li>Documents de l'utilisateur : ${data.statistics.userDocuments}</li>
                            <li>Dossiers de l'utilisateur : ${data.statistics.userFolders}</li>
                        </ul>
                        <button onclick="checkDocuments()" style="margin-top: 15px;">Recharger l'analyse</button>
                    </div>
                `;
                
                // Recharger automatiquement apr√®s 2 secondes
                setTimeout(checkDocuments, 2000);
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="card">
                        <h2>‚ùå Erreur de r√©assignation</h2>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        function displayResults(debug) {
            const resultsDiv = document.getElementById('results');
            
            let html = '';
            
            // Utilisateur actuel
            html += `
                <div class="card">
                    <h2>üë§ Utilisateur Actuel</h2>
                    <div class="grid">
                        <div class="stat-box">
                            <div class="stat-label">Email</div>
                            <div class="stat-value" style="font-size: 16px;">${debug.currentUser.email || 'Non connect√©'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ID</div>
                            <div class="stat-value" style="font-size: 16px;">${debug.currentUser.id || 'N/A'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Statut</div>
                            <div class="stat-value">
                                <span class="status ${debug.currentUser.authenticated ? 'success' : 'error'}">
                                    ${debug.currentUser.authenticated ? 'Connect√©' : 'Non connect√©'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Probl√®mes d√©tect√©s
            if (debug.problems && debug.problems.length > 0) {
                html += '<div class="card"><h2>‚ö†Ô∏è Probl√®mes D√©tect√©s</h2>';
                debug.problems.forEach(problem => {
                    if (problem !== 'Aucun probl√®me d√©tect√©') {
                        html += `<div class="problem">${problem}</div>`;
                    }
                });
                html += '</div>';
            }
            
            // Statistiques
            html += `
                <div class="card">
                    <h2>üìä Statistiques</h2>
                    <div class="grid">
                        <div class="stat-box">
                            <div class="stat-value">${debug.statistics.totalDocuments}</div>
                            <div class="stat-label">Documents totaux</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${debug.statistics.userDocuments}</div>
                            <div class="stat-label">Vos documents</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${debug.statistics.totalFolders}</div>
                            <div class="stat-label">Dossiers totaux</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${debug.statistics.totalUsers}</div>
                            <div class="stat-label">Utilisateurs</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Documents
            if (debug.documents.all && debug.documents.all.length > 0) {
                html += `
                    <div class="card">
                        <h2>üìÑ Documents (${debug.documents.all.length})</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Auteur</th>
                                    <th>Dossier</th>
                                    <th>Fichier</th>
                                    <th>Vous appartient</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                debug.documents.all.forEach(doc => {
                    const belongs = doc.belongsToCurrentUser;
                    html += `
                        <tr class="${belongs ? 'current-user' : ''}">
                            <td><strong>${doc.title}</strong></td>
                            <td>${doc.authorName || 'Inconnu'}<br><small>${doc.authorEmail || ''}</small></td>
                            <td>${doc.folderName || 'Racine'}</td>
                            <td>${doc.fileName || 'N/A'}</td>
                            <td class="${belongs ? 'belongs-yes' : 'belongs-no'}">
                                ${belongs ? '‚úÖ OUI' : '‚ùå NON'}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            // Documents par auteur
            if (debug.documents.byAuthor && Object.keys(debug.documents.byAuthor).length > 0) {
                html += '<div class="card"><h2>üìö Documents par Auteur</h2>';
                for (const [email, docs] of Object.entries(debug.documents.byAuthor)) {
                    html += `<div style="margin: 10px 0;">`;
                    html += `<strong>${email}</strong>: ${docs.join(', ')}`;
                    html += `</div>`;
                }
                html += '</div>';
            }
            
            // Utilisateurs
            if (debug.users && debug.users.length > 0) {
                html += `
                    <div class="card">
                        <h2>üë• Utilisateurs</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Documents</th>
                                    <th>Dossiers</th>
                                    <th>Vous</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                debug.users.forEach(user => {
                    html += `
                        <tr class="${user.isCurrentUser ? 'current-user' : ''}">
                            <td>${user.name || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>${user.documentCount}</td>
                            <td>${user.folderCount}</td>
                            <td>${user.isCurrentUser ? '‚úÖ' : ''}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // Charger automatiquement au d√©marrage
        window.addEventListener('load', checkDocuments);
    </script>
</body>
</html>